var assert = require('assert')
var sinon = require('sinon')
var Transaction = require('bitcoinjs-lib').Transaction
var TxGraph = require('./index')

function fakeTxHash(i) {
  var hash = new Buffer(32)
  hash.fill(i)
  return hash
}

function fakeTxId(i) {
  var hash = fakeTxHash(i)
  Array.prototype.reverse.call(hash)
  return hash.toString('hex')
}

function fakeTx(i) {
  var tx = new Transaction()
  sinon.stub(tx, "getId").returns(fakeTxId(i))
  return tx
}

function getTxIds(txs) {
  return txs.map(function(tx){ return tx.getId()})
}

function assertNodeIdsEqualTxIds(nodes, txids) {
  assert.deepEqual(nodes.map(function(n){ return n.id }).sort(), txids.sort())
}

function assertTxIdsSame(txs1, txs2) {
  assert.deepEqual(getTxIds(txs1).sort(), getTxIds(txs2).sort())
}

describe('TxGraph', function() {
  var txs = []
  var graph = new TxGraph()

  beforeEach(function() {
    for(var i=0; i<7; i++) {
      txs[i] = fakeTx(i)
    }
    txs[0].addInput(fakeTxId(7), 0)
    txs[1].addInput(fakeTxId(8), 0)
    txs[2].addInput(txs[0].getId(), 0)
    txs[2].addInput(txs[1].getId(), 1)
    txs[3].addInput(txs[1].getId(), 0)
    txs[4].addInput(txs[2].getId(), 0)
    txs[4].addInput(txs[3].getId(), 1)
    txs[6].addInput(txs[5].getId(), 0)

    graph.addTx(txs[6])
    graph.addTx(txs[5])
    graph.addTx(txs[0])
    graph.addTx(txs[2])
    graph.addTx(txs[4])
    graph.addTx(txs[3])
    graph.addTx(txs[1])
  })

  describe('addTx', function() {
    it('constructs the graph as expected', function() {
      assertNodeIdsEqualTxIds(graph.heads, [fakeTxId(6), fakeTxId(4)])
      assertNodeIdsEqualTxIds(graph.heads[0].prevNodes, [fakeTxId(5)])
      assertNodeIdsEqualTxIds(graph.heads[1].prevNodes, [fakeTxId(2), fakeTxId(3)])
      assertNodeIdsEqualTxIds(graph.heads[1].prevNodes[0].prevNodes, [fakeTxId(0), fakeTxId(1)])
      assertNodeIdsEqualTxIds(graph.heads[1].prevNodes[1].prevNodes, [fakeTxId(1)])
    })
  })

  describe('getInOrderTxs', function() {
    it('returns transactions in dependency order', function() {
      var orderedTxs = graph.getInOrderTxs()
      assertTxIdsSame(orderedTxs[0], [txs[0], txs[1]])
      assertTxIdsSame(orderedTxs[1], [txs[2], txs[3], txs[5]])
      assertTxIdsSame(orderedTxs[2], [txs[4], txs[6]])
    })
  })

  describe('findNodeById', function() {
    it('returns the node that contains the tx', function() {
      var id = fakeTxId(5)
      var node = graph.findNodeById(id)
      assert.equal(node.id, id)
      assert.equal(node.tx.getId(), id)
    })
  })

  describe('getTails', function() {
    it('returns nodes that everybody else depends on', function() {
      var tails = graph.getTails()
      assertNodeIdsEqualTxIds(graph.getTails(), [fakeTxId(7), fakeTxId(8), fakeTxId(5)])
    })
  })
})
